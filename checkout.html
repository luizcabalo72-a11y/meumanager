<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Meu Manager</title>
  <link rel="icon" type="image/png" href="meumanager-logo-completo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .checkout-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      max-width: 900px;
      width: 100%;
    }
    
    @media (max-width: 800px) {
      .checkout-container {
        grid-template-columns: 1fr;
      }
    }
    
    .checkout-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .checkout-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .checkout-header img {
      height: 40px;
      margin-bottom: 15px;
    }
    
    .checkout-header h1 {
      font-size: 22px;
      color: #003366;
    }
    
    /* Resumo do Plano */
    .plan-summary {
      background: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .plan-name {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .plan-name h2 {
      font-size: 20px;
      color: #003366;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .plan-badge {
      background: #003366;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .plan-features {
      list-style: none;
      margin-bottom: 15px;
    }
    
    .plan-features li {
      padding: 6px 0;
      font-size: 14px;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .plan-features i {
      color: #22c55e;
      font-size: 12px;
    }
    
    .plan-price {
      text-align: center;
      padding-top: 15px;
      border-top: 1px dashed #d1d5db;
    }
    
    .plan-price .amount {
      font-size: 36px;
      font-weight: 800;
      color: #003366;
    }
    
    .plan-price .period {
      font-size: 14px;
      color: #6b7280;
    }
    
    .plan-price .annual-note {
      font-size: 12px;
      color: #22c55e;
      margin-top: 5px;
    }
    
    /* Toggle Per√≠odo */
    .period-toggle {
      display: flex;
      background: #e5e7eb;
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
    }
    
    .period-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .period-btn.active {
      background: white;
      color: #003366;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .period-btn .discount {
      background: #22c55e;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 5px;
    }
    
    /* Formul√°rio */
    .form-section {
      margin-bottom: 20px;
    }
    
    .form-section h3 {
      font-size: 14px;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-section h3 i {
      color: #003366;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #003366;
      box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    /* M√©todos de Pagamento */
    .payment-methods {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method {
      flex: 1;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .payment-method:hover {
      border-color: #003366;
    }
    
    .payment-method.active {
      border-color: #003366;
      background: #f0f7ff;
    }
    
    .payment-method i {
      font-size: 24px;
      color: #003366;
      margin-bottom: 5px;
      display: block;
    }
    
    .payment-method span {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
    }
    
    /* Bot√£o de Pagamento */
    .btn-pay {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #003366 0%, #004488 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
    }
    
    .btn-pay:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,51,102,0.3);
    }
    
    .btn-pay:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-pay.loading i {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Seguran√ßa */
    .security-badges {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .security-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .security-badge i {
      color: #22c55e;
    }
    
    /* Sidebar - Info */
    .checkout-info {
      color: white;
    }
    
    .info-card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }
    
    .info-card h3 {
      font-size: 16px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-card ul {
      list-style: none;
    }
    
    .info-card li {
      padding: 8px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0.9;
    }
    
    .info-card li i {
      color: #22c55e;
    }
    
    .guarantee-card {
      text-align: center;
      padding: 25px;
    }
    
    .guarantee-card i.fa-shield-check {
      font-size: 40px;
      color: #22c55e;
      margin-bottom: 10px;
    }
    
    .guarantee-card h4 {
      margin-bottom: 8px;
    }
    
    .guarantee-card p {
      font-size: 13px;
      opacity: 0.8;
    }
    
    /* Back link */
    .back-link {
      text-align: center;
      margin-top: 15px;
    }
    
    .back-link a {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 14px;
    }
    
    .back-link a:hover {
      color: white;
    }
    
    /* Error/Success messages */
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }
    
    .message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
      display: block;
    }
    
    .message.success {
      background: #f0fdf4;
      color: #16a34a;
      border: 1px solid #bbf7d0;
      display: block;
    }
  </style>
</head>
<body>

  <div class="checkout-container">
    
    <!-- Card Principal -->
    <div class="checkout-card">
      <div class="checkout-header">
        <img src="meumanager-logo-completo.png" alt="Meu Manager">
        <h1>Finalizar Assinatura</h1>
      </div>
      
      <div id="message" class="message"></div>
      
      <!-- Toggle Per√≠odo -->
      <div class="period-toggle">
        <button class="period-btn active" data-period="mensal" onclick="setPeriodo('mensal')">
          Mensal
        </button>
        <button class="period-btn" data-period="anual" onclick="setPeriodo('anual')">
          Anual <span class="discount">-20%</span>
        </button>
      </div>
      
      <!-- Resumo do Plano -->
      <div class="plan-summary">
        <div class="plan-name">
          <h2><i class="fa-solid fa-rocket"></i> <span id="plan-title">Plano Pro</span></h2>
          <span class="plan-badge" id="plan-badge">MAIS POPULAR</span>
        </div>
        
        <ul class="plan-features" id="plan-features">
          <li><i class="fa-solid fa-check"></i> At√© 500 produtos</li>
          <li><i class="fa-solid fa-check"></i> Vendas ilimitadas</li>
          <li><i class="fa-solid fa-check"></i> 3 usu√°rios</li>
          <li><i class="fa-solid fa-check"></i> Relat√≥rios avan√ßados</li>
          <li><i class="fa-solid fa-check"></i> Backup di√°rio</li>
          <li><i class="fa-solid fa-check"></i> Suporte por email</li>
        </ul>
        
        <div class="plan-price">
          <span class="amount" id="plan-price">R$ 47</span>
          <span class="period" id="plan-period">/m√™s</span>
          <p class="annual-note" id="annual-note" style="display:none;">Economia de R$ 120/ano!</p>
        </div>
      </div>
      
      <!-- M√©todos de Pagamento -->
      <div class="form-section">
        <h3><i class="fa-solid fa-credit-card"></i> Forma de Pagamento</h3>
        <div class="payment-methods">
          <div class="payment-method active" data-method="card" onclick="setPaymentMethod('card')">
            <i class="fa-solid fa-credit-card"></i>
            <span>Cart√£o</span>
          </div>
          <div class="payment-method" data-method="pix" onclick="setPaymentMethod('pix')">
            <i class="fa-brands fa-pix"></i>
            <span>PIX</span>
          </div>
          <div class="payment-method" data-method="boleto" onclick="setPaymentMethod('boleto')">
            <i class="fa-solid fa-barcode"></i>
            <span>Boleto</span>
          </div>
        </div>
      </div>
      
      <!-- Formul√°rio Cart√£o -->
      <div id="form-card" class="form-section">
        <h3><i class="fa-solid fa-lock"></i> Dados do Cart√£o</h3>
        
        <div class="form-group">
          <label>N√∫mero do Cart√£o</label>
          <input type="text" id="card-number" placeholder="0000 0000 0000 0000" maxlength="19">
        </div>
        
        <div class="form-group">
          <label>Nome no Cart√£o</label>
          <input type="text" id="card-name" placeholder="NOME COMO EST√Å NO CART√ÉO">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Validade</label>
            <input type="text" id="card-expiry" placeholder="MM/AA" maxlength="5">
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" id="card-cvv" placeholder="123" maxlength="4">
          </div>
        </div>
        
        <div class="form-group">
          <label>CPF do Titular</label>
          <input type="text" id="card-cpf" placeholder="000.000.000-00" maxlength="14">
        </div>
      </div>
      
      <!-- Info PIX -->
      <div id="form-pix" class="form-section" style="display:none;">
        <div class="form-group">
          <label for="pix-email">üìß Email</label>
          <input type="email" id="pix-email" placeholder="seu@email.com" required>
        </div>
        <div class="form-group">
          <label for="pix-cpf">üÜî CPF</label>
          <input type="text" id="pix-cpf" placeholder="000.000.000-00" maxlength="14">
        </div>
        <div style="background:#f0fdf4; padding:15px; border-radius:8px; margin-top:15px; color:#374151; font-size:14px;">
          <i class="fa-brands fa-pix" style="color:#32bcad; margin-right:8px;"></i>
          Ao clicar em pagar, voc√™ receber√° um <strong>QR Code PIX</strong> para pagamento instant√¢neo.
        </div>
      </div>
      
      <!-- Info Boleto -->
      <div id="form-boleto" class="form-section" style="display:none;">
        <div class="form-group">
          <label for="boleto-email">üìß Email <span style="color:#e53e3e;">*</span></label>
          <input type="email" id="boleto-email" placeholder="seu@email.com" required>
        </div>
        <div class="form-group">
          <label for="boleto-cpf">üÜî CPF (Opcional)</label>
          <input type="text" id="boleto-cpf" placeholder="000.000.000-00" maxlength="14">
        </div>
        <div style="background:#fef3c7; padding:15px; border-radius:8px; margin-top:15px; color:#374151; font-size:14px;">
          <i class="fa-solid fa-barcode" style="color:#d97706; margin-right:8px;"></i>
          O boleto ser√° gerado e enviado para seu email. <strong>Prazo: 3 dias √∫teis</strong> para compensar.
        </div>
      </div>
      
      <!-- Bot√£o Pagar -->
      <button class="btn-pay" id="btn-pay" onclick="processPayment()">
        <i class="fa-solid fa-lock"></i>
        <span>Pagar R$ <span id="btn-price">47,00</span></span>
      </button>
      
      <!-- Seguran√ßa -->
      <div class="security-badges">
        <div class="security-badge">
          <i class="fa-solid fa-shield-check"></i>
          Pagamento Seguro
        </div>
        <div class="security-badge">
          <i class="fa-solid fa-lock"></i>
          SSL 256-bit
        </div>
        <div class="security-badge">
          <img src="https://www.mercadopago.com/org-img/Manual/ManualMP/imgs/isologoHorizontal.png" height="16" alt="Mercado Pago">
        </div>
      </div>
    </div>
    
    <!-- Sidebar Info -->
    <div class="checkout-info">
      <div class="info-card">
        <h3><i class="fa-solid fa-gift"></i> O que voc√™ ganha</h3>
        <ul>
          <li><i class="fa-solid fa-check"></i> Acesso imediato ao sistema</li>
          <li><i class="fa-solid fa-check"></i> Todas as funcionalidades do plano</li>
          <li><i class="fa-solid fa-check"></i> Atualiza√ß√µes gratuitas</li>
          <li><i class="fa-solid fa-check"></i> Suporte t√©cnico</li>
          <li><i class="fa-solid fa-check"></i> Cancele quando quiser</li>
        </ul>
      </div>
      
      <div class="info-card guarantee-card">
        <i class="fa-solid fa-shield-check"></i>
        <h4>Garantia de 7 dias</h4>
        <p>Se n√£o ficar satisfeito, devolvemos 100% do seu dinheiro. Sem perguntas.</p>
      </div>
      
      <div class="back-link">
        <a href="planos.html"><i class="fa-solid fa-arrow-left"></i> Voltar para planos</a>
      </div>
    </div>
    
  </div>

  <!-- Mercado Pago SDK -->
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  
  <script>
    // ============ CONFIGURA√á√ÉO ============
    // ‚ö†Ô∏è SUBSTITUA PELA SUA PUBLIC KEY DO MERCADO PAGO
    const MP_PUBLIC_KEY = "APP_USR-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX";
    
    const PLANOS = {
      pro: {
        nome: "Plano Pro",
        mensal: 47,
        anual: 37,
        badge: "MAIS POPULAR",
        features: [
          "At√© 500 produtos",
          "Vendas ilimitadas",
          "3 usu√°rios",
          "Relat√≥rios avan√ßados",
          "Backup di√°rio",
          "Suporte por email"
        ]
      },
      business: {
        nome: "Plano Business",
        mensal: 97,
        anual: 77,
        badge: "COMPLETO",
        features: [
          "Produtos ilimitados",
          "Vendas ilimitadas",
          "10 usu√°rios",
          "Canais ilimitados",
          "Relat√≥rios + exporta√ß√£o",
          "Backup em tempo real",
          "Suporte priorit√°rio",
          "API de integra√ß√£o"
        ]
      }
    };
    
    // ============ ESTADO ============
    let planoAtual = "pro";
    let periodoAtual = "mensal";
    let paymentMethod = "card";
    let mp = null;
    
    // ============ INIT ============
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üìÑ Checkout carregado!");
      
      // Verifica inten√ß√£o de checkout (voltou do login)
      const intent = localStorage.getItem("checkout_intent");
      if (intent) {
        try {
          const { plano, periodo, timestamp } = JSON.parse(intent);
          
          // Verifica se n√£o expirou (30 minutos)
          if (Date.now() - timestamp < 30 * 60 * 1000) {
            const sessao = JSON.parse(localStorage.getItem("ft_sessao") || "{}");
            
            if (sessao && sessao.email) {
              // ‚úÖ Logado e com inten√ß√£o ‚Üí atualiza plano e periodo
              planoAtual = plano;
              periodoAtual = periodo;
              
              // Limpa inten√ß√£o
              localStorage.removeItem("checkout_intent");
              
              console.log("‚úÖ Detectada inten√ß√£o de checkout:", { plano, periodo });
            }
          } else {
            // Expirou
            localStorage.removeItem("checkout_intent");
          }
        } catch (e) {
          localStorage.removeItem("checkout_intent");
        }
      }
      
      // Pega plano da URL (tem prioridade)
      const params = new URLSearchParams(window.location.search);
      if (params.has("plano")) planoAtual = params.get("plano");
      if (params.has("periodo")) periodoAtual = params.get("periodo");
      
      console.log("üîß Checkout config:", { planoAtual, periodoAtual });
      
      // Inicializa Mercado Pago
      if (MP_PUBLIC_KEY && !MP_PUBLIC_KEY.includes("XXXX")) {
        mp = new MercadoPago(MP_PUBLIC_KEY);
      }
      
      // Atualiza UI
      updateUI();
      setupMasks();
    });
    
    // ============ ATUALIZAR UI ============
    function updateUI() {
      const plano = PLANOS[planoAtual];
      if (!plano) return;
      
      const preco = periodoAtual === "anual" ? plano.anual : plano.mensal;
      
      document.getElementById("plan-title").textContent = plano.nome;
      document.getElementById("plan-badge").textContent = plano.badge;
      document.getElementById("plan-price").textContent = `R$ ${preco}`;
      document.getElementById("plan-period").textContent = periodoAtual === "anual" ? "/m√™s (anual)" : "/m√™s";
      document.getElementById("annual-note").style.display = periodoAtual === "anual" ? "block" : "none";
      document.getElementById("btn-price").textContent = preco.toFixed(2).replace(".", ",");
      
      // Features
      const featuresEl = document.getElementById("plan-features");
      featuresEl.innerHTML = plano.features.map(f => 
        `<li><i class="fa-solid fa-check"></i> ${f}</li>`
      ).join("");
      
      // Bot√µes per√≠odo
      document.querySelectorAll(".period-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.period === periodoAtual);
      });
    }
    
    function setPeriodo(periodo) {
      periodoAtual = periodo;
      updateUI();
    }
    
    function setPaymentMethod(method) {
      paymentMethod = method;
      
      document.querySelectorAll(".payment-method").forEach(el => {
        el.classList.toggle("active", el.dataset.method === method);
      });
      
      document.getElementById("form-card").style.display = method === "card" ? "block" : "none";
      document.getElementById("form-pix").style.display = method === "pix" ? "block" : "none";
      document.getElementById("form-boleto").style.display = method === "boleto" ? "block" : "none";
    }
    
    // ============ M√ÅSCARAS ============
    function setupMasks() {
      // Cart√£o
      document.getElementById("card-number")?.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        value = value.replace(/(\d{4})(?=\d)/g, "$1 ");
        e.target.value = value.substring(0, 19);
      });
      
      // Validade
      document.getElementById("card-expiry")?.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.substring(0, 2) + "/" + value.substring(2);
        }
        e.target.value = value.substring(0, 5);
      });
      
      // CPF
      document.getElementById("card-cpf")?.addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        value = value.replace(/(\d{3})(\d)/, "$1.$2");
        value = value.replace(/(\d{3})(\d)/, "$1.$2");
        value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        e.target.value = value.substring(0, 14);
      });
    }
    
    // ============ LIMPAR CAMPOS DO CART√ÉO ============
    function limparCamposCartao() {
      document.getElementById("card-number").value = "";
      document.getElementById("card-name").value = "";
      document.getElementById("card-expiry").value = "";
      document.getElementById("card-cvv").value = "";
      document.getElementById("card-cpf").value = "";
      console.log("üßπ Campos do cart√£o limpos");
    }
    
    // ============ PROCESSAR PAGAMENTO ============
    async function processPayment() {
      const btn = document.getElementById("btn-pay");
      const msgEl = document.getElementById("message");
      
      // Valida√ß√£o b√°sica por m√©todo
      if (paymentMethod === "card") {
        const cardNumber = document.getElementById("card-number").value.replace(/\s/g, "");
        const cardName = document.getElementById("card-name").value.trim();
        const cardExpiry = document.getElementById("card-expiry").value.trim();
        const cardCvv = document.getElementById("card-cvv").value.trim();
        
        // Valida√ß√£o de n√∫mero (apenas d√≠gitos, 13-19 n√∫meros)
        const cardNumberOnly = cardNumber.replace(/\D/g, "");
        if (!cardNumberOnly || cardNumberOnly.length < 13 || cardNumberOnly.length > 19) {
          showMessage("üí≥ N√∫mero do cart√£o inv√°lido (13-19 d√≠gitos)", "error");
          return;
        }
        
        if (!cardName || cardName.length < 3) {
          showMessage("üìù Informe o nome no cart√£o (m√≠nimo 3 caracteres)", "error");
          return;
        }
        
        if (!cardExpiry || !/^\d{2}\/\d{2}$/.test(cardExpiry)) {
          showMessage("üìÖ Validade inv√°lida (formato: MM/AA)", "error");
          return;
        }
        
        if (!cardCvv || cardCvv.length < 3 || cardCvv.length > 4) {
          showMessage("üîê CVV inv√°lido (3 ou 4 d√≠gitos)", "error");
          return;
        }
        
        // ‚úÖ CPF √© opcional em testes
        
        // Valida√ß√£o de cart√µes rejeitados
        const rejeitados = [
          "5425233430109995", // OTHE - Rejeitado
          "5425233430109987", // CONT - Pendente
          "5425233430109911"  // CALL - Sem fundos
        ];
        
        if (rejeitados.includes(cardNumberOnly)) {
          showMessage("‚ùå Este cart√£o foi rejeitado!\n\nColoque outro cart√£o ou mude a forma de pagamento.", "error");
          limparCamposCartao();
          resetButton();
          return;
        }
        
        // Confirma√ß√£o antes de pagar
        const confirmacao = confirm(
          `‚úÖ Dados validados!\n\n` +
          `Cart√£o: ${cardNumberOnly.slice(-4)}\n` +
          `Validade: ${cardExpiry}\n` +
          `Valor: R$ ${PLANOS[planoAtual][periodoAtual === "anual" ? "anual" : "mensal"]}\n\n` +
          `Deseja continuar com o pagamento?`
        );
        
        if (!confirmacao) {
          showMessage("Pagamento cancelado", "warning");
          return;
        }
      } else if (paymentMethod === "pix") {
        const pixEmailEl = document.getElementById("pix-email");
        const pixCpfEl = document.getElementById("pix-cpf");
        
        if (!pixEmailEl || !pixCpfEl) {
          showMessage("‚ùå Formul√°rio do PIX n√£o encontrado", "error");
          return;
        }
        
        const pixEmail = pixEmailEl.value.trim();
        const pixCpf = pixCpfEl.value.trim();
        
        if (!pixEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(pixEmail)) {
          showMessage("üìß Email inv√°lido para PIX", "error");
          return;
        }
        
        if (!pixCpf || pixCpf.replace(/\D/g, "").length < 11) {
          showMessage("üÜî CPF inv√°lido para PIX", "error");
          return;
        }
        
        const confirmacao = confirm(
          `‚úÖ PIX - Dados validados!\n\n` +
          `Email: ${pixEmail}\n` +
          `Valor: R$ ${PLANOS[planoAtual][periodoAtual === "anual" ? "anual" : "mensal"]}\n\n` +
          `Voc√™ receber√° um QR Code para escanear.\n` +
          `Deseja continuar?`
        );
        
        if (!confirmacao) {
          showMessage("Pagamento cancelado", "warning");
          return;
        }
      } else if (paymentMethod === "boleto") {
        const boletoEmailEl = document.getElementById("boleto-email");
        
        if (!boletoEmailEl) {
          showMessage("‚ùå Formul√°rio do Boleto n√£o encontrado", "error");
          return;
        }
        
        const boletoEmail = boletoEmailEl.value.trim();
        
        if (!boletoEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(boletoEmail)) {
          showMessage("üìß Email inv√°lido para Boleto", "error");
          return;
        }
        
        const confirmacao = confirm(
          `‚úÖ Boleto - Dados validados!\n\n` +
          `Email: ${boletoEmail}\n` +
          `Valor: R$ ${PLANOS[planoAtual][periodoAtual === "anual" ? "anual" : "mensal"]}\n\n` +
          `Voc√™ receber√° o boleto por email.\n` +
          `Deseja continuar?`
        );
        
        if (!confirmacao) {
          showMessage("Pagamento cancelado", "warning");
          return;
        }
      }
      
      // Loading
      btn.disabled = true;
      btn.classList.add("loading");
      btn.innerHTML = '<i class="fa-solid fa-spinner"></i> Processando...';
      
      try {
        // Pega dados do usu√°rio logado
        const sessao = JSON.parse(localStorage.getItem("ft_sessao") || "{}");
        const plano = PLANOS[planoAtual];
        const preco = periodoAtual === "anual" ? plano.anual : plano.mensal;
        
        // Limpa campos antes de ir para pagamento
        if (paymentMethod === "card") {
          limparCamposCartao();
        }
        
        // Chama fun√ß√£o para criar prefer√™ncia
        await criarPreferenciaEPagar(sessao, plano, preco);
        
      } catch (error) {
        console.error("Erro no pagamento:", error);
        showMessage("Erro ao processar pagamento. Tente novamente.", "error");
        if (paymentMethod === "card") {
          limparCamposCartao();
        }
        resetButton();
      }
    }

    // ‚úÖ NOVA FUN√á√ÉO: Criar prefer√™ncia e redirecionar para pagamento
    async function criarPreferenciaEPagar(sessao, plano, preco) {
      try {
        // Valida sess√£o (s√≥ precisa de email)
        if (!sessao || !sessao.email) {
          console.log("‚ùå Sess√£o inv√°lida ou email n√£o encontrado");
          showMessage("Fa√ßa login para continuar", "error");
          
          // Salva inten√ß√£o de compra
          localStorage.setItem("checkout_intent", JSON.stringify({ 
            plano: planoAtual, 
            periodo: periodoAtual,
            timestamp: Date.now()
          }));
          
          // Redireciona para login
          setTimeout(() => {
            window.location.href = "login.html";
          }, 1000);
          return;
        }

        const payload = {
          plano: planoAtual,
          periodo: periodoAtual,
          userId: sessao.empresaId || sessao.email,
          email: sessao.email,
          nome: sessao.nome || sessao.email
        };

        // Adiciona CPF para PIX e Boleto
        if (paymentMethod === "pix") {
          const pixCpf = document.getElementById("pix-cpf").value.trim().replace(/\D/g, "");
          payload.cpf = pixCpf;
        } else if (paymentMethod === "boleto") {
          // Boleto pode usar CPF vazio se necess√°rio
          const boletoCpf = document.getElementById("boleto-cpf")?.value.trim().replace(/\D/g, "") || "00000000000";
          payload.cpf = boletoCpf;
        }

        console.log("üì§ Enviando para Cloud Function:", { paymentMethod, ...payload });

        // Define endpoint baseado no m√©todo de pagamento
        let endpoint = "https://us-central1-meumanager-b02b0.cloudfunctions.net/criarPreferencia";
        
        if (paymentMethod === "pix") {
          endpoint = "https://us-central1-meumanager-b02b0.cloudfunctions.net/gerarPix";
        } else if (paymentMethod === "boleto") {
          endpoint = "https://us-central1-meumanager-b02b0.cloudfunctions.net/gerarBoleto";
        }

        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        console.log("‚úÖ Resposta da Cloud Function:", data);
        console.log("üîó pdfUrl recebido:", data.pdfUrl);

        if (data.success) {
          if (paymentMethod === "card") {
            // Cart√£o: redireciona para Mercado Pago
            showMessage("Redirecionando para pagamento...", "success");
            setTimeout(() => {
              const urlPagamento = data.sandboxInitPoint || data.initPoint;
              window.location.href = urlPagamento;
            }, 1000);
          } else if (paymentMethod === "pix") {
            // PIX: mostra QR Code
            if (data.qrCode) {
              exibirQRCodePix(data.qrCode, data.qrCodeUrl, data.valor);
            } else {
              showMessage("‚ùå Erro ao gerar QR Code do PIX. Tente novamente.", "error");
              resetButton();
            }
          } else if (paymentMethod === "boleto") {
            // Boleto: mostra c√≥digo
            if (data.boleto && data.success) {
              console.log("üìã Passando pdfUrl para modal:", data.pdfUrl);
              exibirCodigoBoleto(data.boleto, data.valor, data.dataVencimento, data.pdfUrl);
            } else {
              showMessage(`‚ùå Erro ao gerar boleto: ${data.status_detail || data.error || "Tente novamente"}`, "error");
              resetButton();
            }
          }
        } else {
          const erro = data.error || "Desconhecido";
          showMessage(`‚ùå Erro: ${erro}`, "error");
          resetButton();
        }
      } catch (error) {
        console.error("‚ùå Erro na requisi√ß√£o:", error);
        showMessage(`Erro ao processar: ${error.message}`, "error");
        resetButton();
      }
    }

    // Fun√ß√£o para exibir QR Code do PIX
    // Fun√ß√£o para exibir QR Code do PIX
    function exibirQRCodePix(qrCode, qrCodeUrl, valor) {
      const modal = document.createElement("div");
      modal.className = "payment-modal";
      modal.innerHTML = `
        <div class="payment-modal-content pix-modal">
          <div class="pix-header">
            <i class="fa-brands fa-pix" style="font-size:50px; color:white;"></i>
            <h2>PIX Gerado com Sucesso!</h2>
            <p class="pix-valor">R$ <strong>${valor}</strong></p>
          </div>
          
          <div class="pix-instructions">
            <p>Escaneie o c√≥digo abaixo com seu banco ou app de pagamento</p>
          </div>
          
          <div class="qr-code-container" id="pix-qr-container">
            <!-- QR Code ser√° gerado aqui -->
          </div>
          
          <div class="pix-code-section">
            <p class="pix-code-label">Ou copie a chave PIX:</p>
            <div class="pix-code-box">
              <textarea readonly id="pix-textarea">${qrCode || 'C√≥digo indispon√≠vel'}</textarea>
              <button class="btn-copy" onclick="
                const textarea = document.getElementById('pix-textarea');
                textarea.select();
                document.execCommand('copy');
                this.textContent = '‚úÖ Copiado!';
                setTimeout(() => this.textContent = 'üìã Copiar C√≥digo', 2000);
              ">üìã Copiar C√≥digo</button>
            </div>
          </div>
          
          <div class="pix-validade">
            <i class="fa-solid fa-hourglass-end"></i>
            V√°lido por 30 minutos
          </div>
          
          <button class="btn-close-pix" onclick="this.closest('.payment-modal').remove()">Fechar</button>
        </div>
      `;
      
      const style = document.createElement("style");
      style.textContent = `
        .payment-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          backdrop-filter: blur(2px);
        }
        .payment-modal-content.pix-modal {
          background: white;
          border-radius: 16px;
          max-width: 450px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
        }
        .pix-header {
          background: linear-gradient(135deg, #32bcad 0%, #1f9b8a 100%);
          color: white;
          padding: 30px 20px;
          text-align: center;
        }
        .pix-header h2 {
          margin: 15px 0 10px 0;
          font-size: 22px;
          font-weight: 600;
        }
        .pix-valor {
          font-size: 28px;
          margin: 10px 0 0 0;
          font-weight: 700;
        }
        .pix-instructions {
          padding: 20px;
          background: #f0fdf4;
          text-align: center;
          color: #374151;
          font-size: 14px;
          border-bottom: 1px solid #e5e7eb;
        }
        .qr-code-container {
          padding: 30px 20px;
          text-align: center;
          background: white;
        }
        .qr-code-container img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .pix-code-section {
          padding: 20px;
          background: #f9fafb;
        }
        .pix-code-label {
          font-size: 13px;
          color: #6b7280;
          margin: 0 0 12px 0;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .pix-code-box {
          position: relative;
        }
        .pix-code-box textarea {
          width: 100%;
          height: 100px;
          padding: 12px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          font-family: 'Courier New', monospace;
          font-size: 11px;
          resize: none;
          color: #1f2937;
          background: white;
          line-height: 1.4;
          word-break: break-all;
        }
        .btn-copy {
          width: 100%;
          margin-top: 10px;
          padding: 12px;
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 14px;
        }
        .btn-copy:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .pix-validade {
          padding: 15px 20px;
          background: #fef3c7;
          color: #92400e;
          text-align: center;
          font-size: 13px;
          border-top: 1px solid #fcd34d;
          font-weight: 500;
        }
        .pix-validade i {
          margin-right: 6px;
        }
        .btn-close-pix {
          width: calc(100% - 40px);
          margin: 20px;
          padding: 12px;
          background: #e5e7eb;
          color: #374151;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .btn-close-pix:hover {
          background: #d1d5db;
        }
        .qr-code-container {
          margin: 20px 0;
          background: #f5f5f5;
          padding: 20px;
          border-radius: 8px;
        }
        .qr-code-container img {
          max-width: 100%;
          height: auto;
        }
        .pix-code {
          margin: 20px 0;
        }
        .pix-code textarea {
          width: 100%;
          height: 80px;
          padding: 10px;
          margin: 10px 0;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: monospace;
          font-size: 12px;
        }
        .pix-code button {
          background: #2563eb;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        }
        .pix-info {
          color: #666;
          font-size: 14px;
        }
        .btn-close {
          margin-top: 20px;
          background: #6b7280;
          color: white;
          padding: 10px 30px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Gera o QR Code usando a biblioteca QRCode.js
      if (qrCode) {
        setTimeout(() => {
          const container = document.getElementById("pix-qr-container");
          if (container) {
            container.innerHTML = ""; // Limpa conte√∫do anterior
            new QRCode(container, {
              text: qrCode,
              width: 200,
              height: 200,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });
          }
        }, 100);
      }
      
      resetButton();
    }

    // Fun√ß√£o para exibir c√≥digo do Boleto
    function exibirCodigoBoleto(codigo, valor, vencimento, pdfUrl) {
      // Limpa e formata o c√≥digo
      const codigoLimpo = codigo ? codigo.trim().replace(/[\n\r\s]+/g, "") : "";
      
      const modal = document.createElement("div");
      modal.className = "payment-modal";
      modal.id = "boleto-modal-container";
      modal.innerHTML = `
        <div class="payment-modal-content boleto-modal">
          <div class="boleto-header">
            <i class="fa-solid fa-barcode" style="font-size:50px; color:white;"></i>
            <h2>Boleto Gerado com Sucesso!</h2>
            <p class="boleto-valor">R$ <strong>${valor}</strong></p>
          </div>
          
          <div class="boleto-info-box">
            <div class="boleto-row">
              <span class="label">Vencimento:</span>
              <span class="value">${vencimento}</span>
            </div>
            <div class="boleto-row">
              <span class="label">Status:</span>
              <span class="value" style="color: #f97316;">‚è≥ Aguardando Pagamento</span>
            </div>
          </div>
          
          <div class="boleto-code-section" id="boleto-print-area">
            <p class="boleto-code-label">C√≥digo de Barras:</p>
            
            <!-- C√≥digo de barras visual -->
            <div class="barcode-container">
              <svg id="barcode-svg"></svg>
            </div>
            
            <!-- N√∫meros do c√≥digo -->
            <div class="boleto-code-box">
              <div class="boleto-code-display">${codigoLimpo.replace(/(\d{4,5})(?=\d)/g, "$1 ")}</div>
              <textarea readonly id="boleto-textarea" style="display:none;">${codigoLimpo || 'C√≥digo indispon√≠vel'}</textarea>
            </div>
          </div>
          
          <div class="boleto-actions">
            <button class="btn-copy" onclick="
              const textarea = document.getElementById('boleto-textarea');
              if (textarea.value && textarea.value !== 'C√≥digo indispon√≠vel') {
                textarea.select();
                document.execCommand('copy');
                this.textContent = '‚úÖ Copiado!';
                setTimeout(() => this.textContent = 'üìã Copiar C√≥digo', 2000);
              } else {
                alert('C√≥digo n√£o dispon√≠vel');
              }
            ">üìã Copiar C√≥digo</button>
            
            ${pdfUrl ? `<button class="btn-pdf" onclick="window.open('${pdfUrl}', '_blank')">
              <i class="fa-solid fa-file-pdf"></i> Abrir PDF
            </button>` : `<button class="btn-pdf" disabled title="PDF ainda n√£o dispon√≠vel">
              <i class="fa-solid fa-file-pdf"></i> PDF
            </button>`}
            
            <button class="btn-print" onclick="window.print()">
              <i class="fa-solid fa-print"></i> Imprimir
            </button>
          </div>
          
          <div class="boleto-email-info">
            <i class="fa-solid fa-envelope"></i>
            O boleto tamb√©m ser√° enviado para seu email. <strong>Prazo: 3 dias √∫teis</strong> para compensar.
          </div>
          
          <button class="btn-close-boleto" onclick="this.closest('.payment-modal').remove()">Fechar</button>
        </div>
      `;
      
      const style = document.createElement("style");
      style.textContent = `
        .payment-modal-content.boleto-modal {
          background: white;
          border-radius: 16px;
          max-width: 550px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
        }
        
        .boleto-header {
          background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
          color: white;
          padding: 30px 20px;
          text-align: center;
        }
        
        .boleto-header h2 {
          margin: 15px 0 10px 0;
          font-size: 22px;
          font-weight: 600;
        }
        
        .boleto-valor {
          font-size: 28px;
          margin: 10px 0 0 0;
          font-weight: 700;
        }
        
        .boleto-info-box {
          background: #faf5f0;
          padding: 20px;
          border-bottom: 1px solid #f0e6e0;
        }
        
        .boleto-row {
          display: flex;
          justify-content: space-between;
          padding: 10px 0;
          font-size: 14px;
        }
        
        .boleto-row .label {
          color: #666;
          font-weight: 500;
        }
        
        .boleto-row .value {
          color: #1f2937;
          font-weight: 600;
        }
        
        .boleto-code-section {
          padding: 25px;
        }
        
        .boleto-code-label {
          color: #666;
          font-size: 12px;
          font-weight: 700;
          margin-bottom: 15px;
          display: block;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .barcode-container {
          background: white;
          padding: 20px;
          border: 2px solid #e5e7eb;
          border-radius: 8px;
          margin-bottom: 15px;
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100px;
        }
        
        .barcode-container svg {
          max-width: 100%;
          height: auto;
        }
        
        .boleto-code-box {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }
        
        .boleto-code-display {
          background: #f9fafb;
          border: 2px dashed #d97706;
          padding: 18px;
          border-radius: 8px;
          font-family: 'Courier New', 'Courier', monospace;
          font-size: 14px;
          font-weight: 700;
          letter-spacing: 1px;
          text-align: center;
          color: #1f2937;
          word-break: break-word;
          line-height: 1.6;
        }
        
        .boleto-actions {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 10px;
          padding: 0 25px 20px 25px;
        }
        
        .btn-copy, .btn-print, .btn-pdf {
          padding: 12px 16px;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          font-size: 13px;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
        }
        
        .btn-copy, .btn-print, .btn-pdf:not(:disabled) {
          cursor: pointer;
        }
        
        .btn-pdf:disabled {
          background: #d1d5db;
          color: #9ca3af;
          cursor: not-allowed;
          opacity: 0.6;
        }
        
        .btn-copy {
          background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
          color: white;
        }
        
        .btn-copy:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn-print {
          background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
          color: white;
        }
        
        .btn-print:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(124, 58, 237, 0.3);
        }
        
        .btn-pdf {
          background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
          color: white;
        }
        
        .btn-pdf:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
        }
        
        .boleto-email-info {
          background: #fef3c7;
          color: #b45309;
          padding: 15px 20px;
          border-left: 4px solid #d97706;
          font-size: 13px;
          line-height: 1.6;
          margin: 0 25px 20px 25px;
          border-radius: 6px;
        }
        
        .btn-close-boleto {
          display: block;
          width: calc(100% - 40px);
          margin: 0 20px 20px 20px;
          padding: 12px;
          background: #f3f4f6;
          color: #374151;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s;
        }
        
        .btn-close-boleto:hover {
          background: #e5e7eb;
        }
        
        @media print {
          .payment-modal {
            background: white !important;
          }
          .payment-modal-content.boleto-modal {
            box-shadow: none;
            width: 100%;
            max-width: 100%;
          }
          .boleto-actions, .btn-close-boleto {
            display: none !important;
          }
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Gera c√≥digo de barras visual ap√≥s inserir no DOM
      if (codigoLimpo) {
        setTimeout(() => {
          try {
            JsBarcode("#barcode-svg", codigoLimpo, {
              format: "CODE128",
              width: 2,
              height: 80,
              margin: 10,
              lineColor: "#1f2937"
            });
          } catch (e) {
            console.error("Erro ao gerar c√≥digo de barras:", e);
          }
        }, 100);
      }
      
      resetButton();
    }
    
    function showMessage(msg, type) {
      const el = document.getElementById("message");
      el.textContent = msg;
      el.className = `message ${type}`;
    }
    
    function resetButton() {
      const btn = document.getElementById("btn-pay");
      const plano = PLANOS[planoAtual];
      const preco = periodoAtual === "anual" ? plano.anual : plano.mensal;
      
      btn.disabled = false;
      btn.classList.remove("loading");
      btn.innerHTML = `<i class="fa-solid fa-lock"></i> <span>Pagar R$ ${preco.toFixed(2).replace(".", ",")}</span>`;
    }
  </script>

</body>
</html>
